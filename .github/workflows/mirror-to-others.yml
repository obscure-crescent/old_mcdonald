name: Mirror GHCR images to Quay + Docker Hub

on:
  workflow_run:
    workflows: ["Build honse-farm images to GHCR"]
    types: [completed]

  workflow_dispatch:
    inputs:
      tag:
        description: "Short tag to mirror (e.g. 1a2b3c4). Leave empty to read from .upstream-commit."
        required: false
        default: ""
      branch:
        description: "Branch to read .upstream-commit from (only used if tag is empty)."
        required: false
        default: "main"
      mirror_dev_latest:
        description: "Also mirror :dev-latest"
        type: boolean
        required: false
        default: true
      target:
        description: "Where to mirror images"
        type: choice
        required: false
        default: "both"
        options:
          - both
          - quay
          - dockerhub

permissions:
  contents: read

env:
  GHCR_OWNER: obscure-crescent
  QUAY_ORG: farminator
  DOCKERHUB_NAMESPACE: iferniton

jobs:
  mirror:
    if: >-
      ${{
        github.event_name == 'workflow_dispatch' ||
        github.event.workflow_run.conclusion == 'success'
      }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # Each entry defines:
          # - src: GHCR image name
          # - quay: Quay repo name
          # - dh: Docker Hub repo name
          - src: honse-honsefarm.server
            quay: honse-honsefarm.server
            dh: honsefarm.server
          - src: honse-honsefarm.fileserver
            quay: honse-honsefarm.fileserver
            dh: honsefarm.fileserver
          - src: honse-honsefarm.adminpanel
            quay: honse-honsefarm.adminpanel
            dh: honsefarm.adminpanel

    steps:
      - name: Decide checkout ref
        id: ref
        run: |
          set -euo pipefail
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ref=${{ inputs.branch }}" >> "$GITHUB_OUTPUT"
          else
            echo "ref=${{ github.event.workflow_run.head_branch }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repo (for .upstream-commit)
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.ref.outputs.ref }}

      - name: Determine tag
        id: tag
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.tag }}" ]; then
            T="${{ inputs.tag }}"
            echo "Using manually provided tag: $T"
            echo "tag=$T" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          if [ ! -f .upstream-commit ]; then
            echo "Missing .upstream-commit; cannot determine tag."
            exit 1
          fi

          FULL="$(tr -d '\n' < .upstream-commit)"
          SHORT="${FULL::7}"

          echo "Read upstream commit: $FULL"
          echo "Using short tag: $SHORT"
          echo "full=$FULL" >> "$GITHUB_OUTPUT"
          echo "tag=$SHORT" >> "$GITHUB_OUTPUT"

      - name: Install skopeo
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      # -------------------------
      # Quay mirror
      # -------------------------
      - name: Mirror tag to Quay
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.target == 'both' || inputs.target == 'quay' }}
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          SRC="docker://ghcr.io/${{ env.GHCR_OWNER }}/${{ matrix.src }}:${TAG}"
          DST="docker://quay.io/${{ env.QUAY_ORG }}/${{ matrix.quay }}:${TAG}"

          echo "Copying $SRC -> $DST"
          skopeo copy --all --retry-times 5 \
            --dest-creds "${{ secrets.QUAY_USERNAME }}:${{ secrets.QUAY_PASSWORD }}" \
            "$SRC" "$DST"

      - name: Mirror dev-latest to Quay
        if: >-
          ${{
            (github.event_name != 'workflow_dispatch' || inputs.mirror_dev_latest) &&
            (github.event_name != 'workflow_dispatch' || inputs.target == 'both' || inputs.target == 'quay')
          }}
        run: |
          set -euo pipefail
          SRC="docker://ghcr.io/${{ env.GHCR_OWNER }}/${{ matrix.src }}:dev-latest"
          DST="docker://quay.io/${{ env.QUAY_ORG }}/${{ matrix.quay }}:dev-latest"

          echo "Copying $SRC -> $DST"
          skopeo copy --all --retry-times 5 \
            --dest-creds "${{ secrets.QUAY_USERNAME }}:${{ secrets.QUAY_PASSWORD }}" \
            "$SRC" "$DST"

      # -------------------------
      # Docker Hub mirror
      # -------------------------
      - name: Mirror tag to Docker Hub
        if: ${{ github.event_name != 'workflow_dispatch' || inputs.target == 'both' || inputs.target == 'dockerhub' }}
        run: |
          set -euo pipefail
          TAG="${{ steps.tag.outputs.tag }}"
          SRC="docker://ghcr.io/${{ env.GHCR_OWNER }}/${{ matrix.src }}:${TAG}"
          DST="docker://docker.io/${{ env.DOCKERHUB_NAMESPACE }}/${{ matrix.dh }}:${TAG}"

          echo "Copying $SRC -> $DST"
          skopeo copy --all --retry-times 5 \
            --dest-creds "${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_PASSWORD }}" \
            "$SRC" "$DST"

      - name: Mirror dev-latest to Docker Hub
        if: >-
          ${{
            (github.event_name != 'workflow_dispatch' || inputs.mirror_dev_latest) &&
            (github.event_name != 'workflow_dispatch' || inputs.target == 'both' || inputs.target == 'dockerhub')
          }}
        run: |
          set -euo pipefail
          SRC="docker://ghcr.io/${{ env.GHCR_OWNER }}/${{ matrix.src }}:dev-latest"
          DST="docker://docker.io/${{ env.DOCKERHUB_NAMESPACE }}/${{ matrix.dh }}:dev-latest"

          echo "Copying $SRC -> $DST"
          skopeo copy --all --retry-times 5 \
            --dest-creds "${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_PASSWORD }}" \
            "$SRC" "$DST"
